<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üí§ –î–Ω–µ–≤–Ω–∏–∫ –°–Ω–∞</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Comic Sans MS', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #dc2626 0%, #f59e0b 50%, #fbbf24 100%);
            min-height: 100vh;
            padding: 20px;
            color: #fff;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(0,0,0,0.2);
            padding: 20px;
            border-radius: 15px;
        }

        .title {
            font-size: 32px;
            font-weight: bold;
            color: #fff;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.5);
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 16px;
            color: #fef3c7;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            border: 2px solid #fff;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .mode-switcher {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .mode-btn {
            flex: 1;
            padding: 15px;
            border: 2px solid #fff;
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .mode-btn.active {
            background: #fff;
            color: #dc2626;
        }

        .mode-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .mode-btn.active:hover {
            background: #fff;
        }

        .card {
            background: rgba(220, 38, 38, 0.8);
            border: 3px solid #fbbf24;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .section-header {
            font-size: 22px;
            font-weight: bold;
            color: #fef3c7;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #fef3c7;
            font-size: 16px;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px;
            border: 3px solid #fbbf24;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.95);
            color: #dc2626;
            font-size: 16px;
            font-family: 'Comic Sans MS', 'Segoe UI', sans-serif;
            font-weight: bold;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #fef3c7;
            background: #fff;
        }

        .checkbox-group {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .checkbox-label:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: #fbbf24;
        }

        .checkbox-label input[type="checkbox"] {
            width: 24px;
            height: 24px;
            cursor: pointer;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.3s;
            font-family: 'Comic Sans MS', sans-serif;
        }

        .btn-primary {
            background: #fbbf24;
            color: #dc2626;
            border: 3px solid #fff;
        }

        .btn-primary:hover {
            background: #fef3c7;
            transform: scale(1.05);
        }

        .btn-success {
            background: #10b981;
            color: white;
            width: 100%;
            margin-top: 20px;
            border: 3px solid #fff;
        }

        .btn-success:hover {
            background: #059669;
        }

        .support-message {
            background: linear-gradient(135deg, #fbbf24, #fef3c7);
            color: #dc2626;
            padding: 25px;
            border-radius: 20px;
            text-align: center;
            margin-bottom: 20px;
            animation: bounce 0.6s;
            border: 3px solid #fff;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .support-icon {
            font-size: 56px;
            margin-bottom: 10px;
        }

        .support-text {
            font-size: 20px;
            font-weight: bold;
        }

        .sleep-info {
            background: rgba(255, 255, 255, 0.2);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 2px solid #fbbf24;
        }

        .sleep-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .sleep-stat:last-child {
            margin-bottom: 0;
        }

        .stat-label {
            font-weight: bold;
        }

        .stat-value {
            font-size: 24px;
            color: #fef3c7;
        }

        .history-item {
            background: rgba(255, 255, 255, 0.15);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            border-left: 5px solid #fbbf24;
        }

        .history-date {
            font-weight: bold;
            color: #fef3c7;
            margin-bottom: 8px;
            font-size: 16px;
        }

        .history-detail {
            font-size: 14px;
            margin-bottom: 5px;
        }

        .good-sleep {
            border-left-color: #10b981;
            background: rgba(16, 185, 129, 0.2);
        }

        .bad-sleep {
            border-left-color: #ef4444;
            background: rgba(239, 68, 68, 0.2);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.2);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            border: 2px solid #fbbf24;
        }

        .stat-card-value {
            font-size: 36px;
            font-weight: bold;
            color: #fef3c7;
            margin-bottom: 5px;
        }

        .stat-card-label {
            font-size: 14px;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #fef3c7;
        }

        .no-data-icon {
            font-size: 64px;
            margin-bottom: 15px;
        }

        @media (max-width: 600px) {
            .checkbox-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="../index.html" class="back-btn">‚Üê –ù–∞–∑–∞–¥ –∫ –ø—Ä–æ—Ñ–∏–ª—é</a>

        <div class="header">
            <div class="title">üí§ –¢–†–ê-–õ–Ø-–õ–Ø! –î–ù–ï–í–ù–ò–ö –°–ù–ê! üí§</div>
            <div class="subtitle">–ö–∞–ø–∏—Ç–∞–Ω –ü–æ–¥—à—Ç–∞–Ω–Ω–∏–∫ —Å–ª–µ–¥–∏—Ç –∑–∞ —Ç–≤–æ–∏–º —Å–Ω–æ–º!</div>
        </div>

        <div class="mode-switcher">
            <button class="mode-btn" onclick="switchMode('mama')">üë©‚Äç‚öïÔ∏è –î–ª—è –º–∞–º—ã</button>
            <button class="mode-btn active" onclick="switchMode('toshka')">ü¶∏ –î–ª—è –¢–æ—à–∫–∏</button>
        </div>

        <!-- –°–ï–ö–¶–ò–Ø –î–õ–Ø –¢–û–®–ö–ò -->
        <section id="toshkaSection" class="section active">
            <div id="supportMessageContainer"></div>

            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ–≥–æ–¥–Ω—è -->
            <div class="card" id="todaySleepCard" style="display: none;">
                <div class="section-header">
                    <span>üìä</span>
                    <span>–°–æ–Ω —Å–µ–≥–æ–¥–Ω—è</span>
                </div>
                <div id="todaySleepInfo"></div>
            </div>

            <!-- –§–æ—Ä–º–∞ –∑–∞–ø–∏—Å–∏ —Å–Ω–∞ -->
            <div class="card">
                <div class="section-header">
                    <span>üõèÔ∏è</span>
                    <span>–ó–∞–ø–∏—Å–∞—Ç—å —Å–æ–Ω</span>
                </div>

                <form id="sleepForm" onsubmit="saveSleep(event)">
                    <div class="form-group">
                        <label class="form-label">üìÖ –ó–∞ –∫–∞–∫—É—é –¥–∞—Ç—É –∑–∞–ø–∏—Å—ã–≤–∞–µ—à—å?</label>
                        <input type="date" id="sleepDate" class="form-input" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">üåô –í–æ —Å–∫–æ–ª—å–∫–æ –ª–µ–≥ —Å–ø–∞—Ç—å?</label>
                        <input type="time" id="bedTime" class="form-input" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">‚òÄÔ∏è –í–æ —Å–∫–æ–ª—å–∫–æ –ø—Ä–æ—Å–Ω—É–ª—Å—è?</label>
                        <input type="time" id="wakeTime" class="form-input" value="05:50" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">üì± –ë—ã–ª —Å —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º –ø–µ—Ä–µ–¥ —Å–Ω–æ–º?</label>
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="radio" name="phone" value="yes" required>
                                <span>–î–∞ üòî</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="radio" name="phone" value="no">
                                <span>–ù–µ—Ç üòä</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">üò¥ –ö–∞–∫ —Å–µ–±—è —á—É–≤—Å—Ç–≤–æ–≤–∞–ª —É—Ç—Ä–æ–º?</label>
                        <select id="feeling" class="form-select" required>
                            <option value="">–í—ã–±–µ—Ä–∏...</option>
                            <option value="excellent">üòä –û—Ç–ª–∏—á–Ω–æ! –ë–æ–¥—Ä—ã–π –∏ –ø–æ–ª–æ–Ω —Å–∏–ª!</option>
                            <option value="good">üôÇ –•–æ—Ä–æ—à–æ, –Ω–æ—Ä–º–∞–ª—å–Ω–æ</option>
                            <option value="tired">üòê –£—Å—Ç–∞–≤—à–∏–π, —Ö–æ—Ç–µ–ª–æ—Å—å –µ—â—ë –ø–æ—Å–ø–∞—Ç—å</option>
                            <option value="bad">üòü –ü–ª–æ—Ö–æ, –æ—á–µ–Ω—å —É—Å—Ç–∞–ª</option>
                        </select>
                    </div>

                    <button type="submit" class="btn btn-success">üíæ –°–û–•–†–ê–ù–ò–¢–¨!</button>
                </form>
            </div>

            <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏ -->
            <div class="card">
                <div class="section-header">
                    <span>üìñ</span>
                    <span>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –Ω–æ—á–∏</span>
                </div>
                <div id="recentSleepList"></div>
            </div>
        </section>

        <!-- –°–ï–ö–¶–ò–Ø –î–õ–Ø –ú–ê–ú–´ -->
        <section id="mamaSection" class="section">
            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="card">
                <div class="section-header">
                    <span>üìä</span>
                    <span>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–Ω–∞</span>
                </div>
                <div class="stats-grid" id="statsGrid"></div>
            </div>

            <!-- –í—Å—è –∏—Å—Ç–æ—Ä–∏—è -->
            <div class="card">
                <div class="section-header">
                    <span>üìö</span>
                    <span>–í—Å–µ –∑–∞–ø–∏—Å–∏</span>
                </div>
                <div id="allSleepList"></div>
                
                <button class="btn btn-primary" style="width: 100%; margin-top: 20px;" onclick="downloadReport()">
                    üì• –°–∫–∞—á–∞—Ç—å –æ—Ç—á–µ—Ç
                </button>
            </div>
        </section>
    </div>

    <script>
        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        window.addEventListener('DOMContentLoaded', function() {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            document.getElementById('sleepDate').valueAsDate = yesterday;
            
            loadTodaySleep();
            loadRecentSleep();
        });

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–æ–≤
        function switchMode(mode) {
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
            
            if (mode === 'mama') {
                document.getElementById('mamaSection').classList.add('active');
                displayStats();
                displayAllSleep();
            } else {
                document.getElementById('toshkaSection').classList.add('active');
                loadTodaySleep();
                loadRecentSleep();
            }
        }

        // –†–∞—Å—á–µ—Ç —á–∞—Å–æ–≤ —Å–Ω–∞
        function calculateSleepHours(bedTime, wakeTime) {
            const [bedH, bedM] = bedTime.split(':').map(Number);
            const [wakeH, wakeM] = wakeTime.split(':').map(Number);
            
            let bedMinutes = bedH * 60 + bedM;
            let wakeMinutes = wakeH * 60 + wakeM;
            
            // –ï—Å–ª–∏ –≤—Ä–µ–º—è —Å–Ω–∞ –ø–æ–∑–¥–Ω–µ–µ –ø–æ–ª—É–Ω–æ—á–∏, –¥–æ–±–∞–≤–ª—è–µ–º 24 —á–∞—Å–∞
            if (wakeMinutes < bedMinutes) {
                wakeMinutes += 24 * 60;
            }
            
            const totalMinutes = wakeMinutes - bedMinutes;
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            
            return { hours, minutes, total: totalMinutes / 60 };
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–Ω–∞
        function saveSleep(event) {
            event.preventDefault();
            
            const sleepDate = document.getElementById('sleepDate').value;
            const bedTime = document.getElementById('bedTime').value;
            const wakeTime = document.getElementById('wakeTime').value;
            const phone = document.querySelector('input[name="phone"]:checked').value;
            const feeling = document.getElementById('feeling').value;
            
            const sleepCalc = calculateSleepHours(bedTime, wakeTime);
            
            const sleepRecord = {
                date: sleepDate,
                bedTime: bedTime,
                wakeTime: wakeTime,
                sleepHours: sleepCalc.total,
                phone: phone,
                feeling: feeling,
                timestamp: new Date().toISOString()
            };
            
            // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
            const history = JSON.parse(localStorage.getItem('toshkaSleepHistory') || '[]');
            
            // –£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å –∑–∞ —ç—Ç—É –¥–∞—Ç—É –µ—Å–ª–∏ –µ—Å—Ç—å
            const filtered = history.filter(s => s.date !== sleepDate);
            filtered.push(sleepRecord);
            
            localStorage.setItem('toshkaSleepHistory', JSON.stringify(filtered));
            
            // –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É
            showSupportMessage(sleepRecord);
            
            alert('‚úÖ –°–æ–Ω –∑–∞–ø–∏—Å–∞–Ω!');
            document.getElementById('sleepForm').reset();
            
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            document.getElementById('sleepDate').valueAsDate = yesterday;
            document.getElementById('wakeTime').value = '05:50';
            
            loadTodaySleep();
            loadRecentSleep();
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–¥–¥–µ—Ä–∂–∫–∏
        function showSupportMessage(record) {
            const container = document.getElementById('supportMessageContainer');
            
            const targetBedTime = 22 * 60; // 22:00 –≤ –º–∏–Ω—É—Ç–∞—Ö
            const [bedH, bedM] = record.bedTime.split(':').map(Number);
            const actualBedTime = bedH * 60 + bedM;
            
            const onTime = actualBedTime <= targetBedTime + 30; // 30 –º–∏–Ω—É—Ç –¥–æ–ø—É—Å–∫
            const goodSleep = record.sleepHours >= 7.5;
            const noPhone = record.phone === 'no';
            const goodFeeling = record.feeling === 'excellent' || record.feeling === 'good';
            
            let message = '';
            let icon = '';
            
            if (onTime && goodSleep && noPhone && goodFeeling) {
                message = 'üèÜ –¢–†–ê-–õ–Ø-–õ–Ø! –ò–î–ï–ê–õ–¨–ù–´–ô –°–û–ù! –ö–∞–ø–∏—Ç–∞–Ω –≥–æ—Ä–¥–∏—Ç—Å—è!';
                icon = 'ü¶∏';
            } else if (onTime && goodSleep) {
                message = 'üí™ –û–¢–õ–ò–ß–ù–û! –õ–µ–≥ –≤–æ–≤—Ä–µ–º—è –∏ –≤—ã—Å–ø–∞–ª—Å—è! –°—É–ø–µ—Ä–≥–µ—Ä–æ–π—Å–∫–∏–π —Å–æ–Ω!';
                icon = 'ü¶∏';
            } else if (onTime) {
                message = 'üëç –ú–û–õ–û–î–ï–¶! –õ–µ–≥ –≤–æ–≤—Ä–µ–º—è! –ö–∞–ø–∏—Ç–∞–Ω –æ–¥–æ–±—Ä—è–µ—Ç!';
                icon = 'ü¶∏';
            } else if (goodSleep) {
                message = 'üòä –•–æ—Ä–æ—à–æ –≤—ã—Å–ø–∞–ª—Å—è! –ù–æ –ø–æ–ø—Ä–æ–±—É–π –ª–µ—á—å –ø–æ—Ä–∞–Ω—å—à–µ!';
                icon = 'üí§';
            } else {
                message = 'üíô –ö–∞–ø–∏—Ç–∞–Ω –≤–µ—Ä–∏—Ç –≤ —Ç–µ–±—è! –°–µ–≥–æ–¥–Ω—è –ª—è–∂–µ—à—å –ø–æ—Ä–∞–Ω—å—à–µ!';
                icon = 'ü¶∏';
            }
            
            container.innerHTML = `
                <div class="support-message">
                    <div class="support-icon">${icon}</div>
                    <div class="support-text">${message}</div>
                </div>
            `;
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–≥–æ —Å–Ω–∞
        function loadTodaySleep() {
            const today = new Date().toISOString().split('T')[0];
            const history = JSON.parse(localStorage.getItem('toshkaSleepHistory') || '[]');
            const todayRecord = history.find(s => s.date === today);
            
            const card = document.getElementById('todaySleepCard');
            const info = document.getElementById('todaySleepInfo');
            
            if (!todayRecord) {
                card.style.display = 'none';
                return;
            }
            
            card.style.display = 'block';
            
            const sleepCalc = calculateSleepHours(todayRecord.bedTime, todayRecord.wakeTime);
            const feelingText = {
                excellent: '–û—Ç–ª–∏—á–Ω–æ!',
                good: '–•–æ—Ä–æ—à–æ',
                tired: '–£—Å—Ç–∞–≤—à–∏–π',
                bad: '–ü–ª–æ—Ö–æ'
            };
            
            info.innerHTML = `
                <div class="sleep-info">
                    <div class="sleep-stat">
                        <span class="stat-label">üåô –õ–µ–≥ —Å–ø–∞—Ç—å:</span>
                        <span class="stat-value">${todayRecord.bedTime}</span>
                    </div>
                    <div class="sleep-stat">
                        <span class="stat-label">‚òÄÔ∏è –ü—Ä–æ—Å–Ω—É–ª—Å—è:</span>
                        <span class="stat-value">${todayRecord.wakeTime}</span>
                    </div>
                    <div class="sleep-stat">
                        <span class="stat-label">‚è∞ –°–ø–∞–ª:</span>
                        <span class="stat-value">${sleepCalc.hours}—á ${sleepCalc.minutes}–º–∏–Ω</span>
                    </div>
                    <div class="sleep-stat">
                        <span class="stat-label">üì± –¢–µ–ª–µ—Ñ–æ–Ω:</span>
                        <span class="stat-value">${todayRecord.phone === 'yes' ? '–î–∞' : '–ù–µ—Ç'}</span>
                    </div>
                    <div class="sleep-stat">
                        <span class="stat-label">üò¥ –°–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ:</span>
                        <span class="stat-value">${feelingText[todayRecord.feeling]}</span>
                    </div>
                </div>
            `;
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∑–∞–ø–∏—Å–µ–π
        function loadRecentSleep() {
            const history = JSON.parse(localStorage.getItem('toshkaSleepHistory') || '[]');
            const container = document.getElementById('recentSleepList');
            
            if (history.length === 0) {
                container.innerHTML = '<div class="no-data"><div class="no-data-icon">üí§</div><p>–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π –æ —Å–Ω–µ</p></div>';
                return;
            }
            
            const sorted = [...history].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 7);
            container.innerHTML = sorted.map(record => formatSleepItem(record)).join('');
        }

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏
        function formatSleepItem(record) {
            const date = new Date(record.date);
            const dateStr = date.toLocaleDateString('ru-RU', {day: '2-digit', month: '2-digit', year: 'numeric'});
            
            const sleepCalc = calculateSleepHours(record.bedTime, record.wakeTime);
            const goodSleep = record.sleepHours >= 7.5;
            const itemClass = goodSleep ? 'good-sleep' : 'bad-sleep';
            
            const feelingEmoji = {
                excellent: 'üòä',
                good: 'üôÇ',
                tired: 'üòê',
                bad: 'üòü'
            };
            
            return `
                <div class="history-item ${itemClass}">
                    <div class="history-date">${dateStr}</div>
                    <div class="history-detail">üåô –õ–µ–≥: ${record.bedTime} ‚Üí ‚òÄÔ∏è –í—Å—Ç–∞–ª: ${record.wakeTime}</div>
                    <div class="history-detail">‚è∞ –°–ø–∞–ª: ${sleepCalc.hours}—á ${sleepCalc.minutes}–º–∏–Ω</div>
                    <div class="history-detail">üì± –¢–µ–ª–µ—Ñ–æ–Ω: ${record.phone === 'yes' ? '–î–∞' : '–ù–µ—Ç'} | ${feelingEmoji[record.feeling]} ${record.feeling === 'excellent' ? '–û—Ç–ª–∏—á–Ω–æ' : record.feeling === 'good' ? '–•–æ—Ä–æ—à–æ' : record.feeling === 'tired' ? '–£—Å—Ç–∞–ª' : '–ü–ª–æ—Ö–æ'}</div>
                </div>
            `;
        }

        // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        function displayStats() {
            const history = JSON.parse(localStorage.getItem('toshkaSleepHistory') || '[]');
            const container = document.getElementById('statsGrid');
            
            if (history.length === 0) {
                container.innerHTML = '<div class="no-data" style="grid-column: 1/-1;"><p>–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p></div>';
                return;
            }
            
            const totalNights = history.length;
            const avgSleep = history.reduce((sum, r) => sum + r.sleepHours, 0) / totalNights;
            const goodSleepCount = history.filter(r => r.sleepHours >= 7.5).length;
            const noPhoneCount = history.filter(r => r.phone === 'no').length;
            
            // –ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π
            const last7 = history.slice(-7);
            const streak = calculateStreak(history);
            
            container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-card-value">${totalNights}</div>
                    <div class="stat-card-label">–í—Å–µ–≥–æ –Ω–æ—á–µ–π</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-value">${avgSleep.toFixed(1)}—á</div>
                    <div class="stat-card-label">–°—Ä–µ–¥–Ω–∏–π —Å–æ–Ω</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-value">${goodSleepCount}</div>
                    <div class="stat-card-label">–í—ã—Å–ø–∞–ª—Å—è (7.5—á+)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-value">${noPhoneCount}</div>
                    <div class="stat-card-label">–ë–µ–∑ —Ç–µ–ª–µ—Ñ–æ–Ω–∞</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-value">${streak}</div>
                    <div class="stat-card-label">–î–Ω–µ–π –ø–æ–¥—Ä—è–¥ –≤–æ–≤—Ä–µ–º—è</div>
                </div>
            `;
        }

        // –†–∞—Å—á–µ—Ç —Å–µ—Ä–∏–∏
        function calculateStreak(history) {
            const sorted = [...history].sort((a, b) => new Date(b.date) - new Date(a.date));
            let streak = 0;
            const targetBedTime = 22 * 60 + 30; // 22:30
            
            for (const record of sorted) {
                const [bedH, bedM] = record.bedTime.split(':').map(Number);
                const actualBedTime = bedH * 60 + bedM;
                
                if (actualBedTime <= targetBedTime) {
                    streak++;
                } else {
                    break;
                }
            }
            
            return streak;
        }

        // –í—Å—è –∏—Å—Ç–æ—Ä–∏—è
        function displayAllSleep() {
            const history = JSON.parse(localStorage.getItem('toshkaSleepHistory') || '[]');
            const container = document.getElementById('allSleepList');
            
            if (history.length === 0) {
                container.innerHTML = '<div class="no-data"><div class="no-data-icon">üìö</div><p>–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π</p></div>';
                return;
            }
            
            const sorted = [...history].sort((a, b) => new Date(b.date) - new Date(a.date));
            container.innerHTML = sorted.map(record => formatSleepItem(record)).join('');
        }

        // –°–∫–∞—á–∞—Ç—å –æ—Ç—á–µ—Ç
        function downloadReport() {
            const history = JSON.parse(localStorage.getItem('toshkaSleepHistory') || '[]');
            
            if (history.length === 0) {
                alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç—á–µ—Ç–∞');
                return;
            }
            
            let report = '=== –û–¢–ß–ï–¢ –ü–û –°–ù–£ - –¢–û–®–ö–ê ===\n\n';
            report += `–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è: ${new Date().toLocaleString('ru-RU')}\n\n`;
            
            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            const avgSleep = history.reduce((sum, r) => sum + r.sleepHours, 0) / history.length;
            const goodSleep = history.filter(r => r.sleepHours >= 7.5).length;
            const noPhone = history.filter(r => r.phone === 'no').length;
            
            report += '--- –°–¢–ê–¢–ò–°–¢–ò–ö–ê ---\n';
            report += `–í—Å–µ–≥–æ –Ω–æ—á–µ–π: ${history.length}\n`;
            report += `–°—Ä–µ–¥–Ω—è—è –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–Ω–∞: ${avgSleep.toFixed(1)} —á–∞—Å–æ–≤\n`;
            report += `–í—ã—Å–ø–∞–ª—Å—è (7.5—á+): ${goodSleep} —Ä–∞–∑\n`;
            report += `–ë–µ–∑ —Ç–µ–ª–µ—Ñ–æ–Ω–∞: ${noPhone} —Ä–∞–∑\n\n`;
            
            // –ò—Å—Ç–æ—Ä–∏—è
            report += '--- –ò–°–¢–û–†–ò–Ø –°–ù–ê ---\n\n';
            const sorted = [...history].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sorted.forEach(record => {
                const sleepCalc = calculateSleepHours(record.bedTime, record.wakeTime);
                const feelingText = {excellent: '–û—Ç–ª–∏—á–Ω–æ', good: '–•–æ—Ä–æ—à–æ', tired: '–£—Å—Ç–∞–ª', bad: '–ü–ª–æ—Ö–æ'};
                
                report += `–î–∞—Ç–∞: ${new Date(record.date).toLocaleDateString('ru-RU')}\n`;
                report += `–õ–µ–≥ —Å–ø–∞—Ç—å: ${record.bedTime}\n`;
                report += `–ü—Ä–æ—Å–Ω—É–ª—Å—è: ${record.wakeTime}\n`;
                report += `–°–ø–∞–ª: ${sleepCalc.hours}—á ${sleepCalc.minutes}–º–∏–Ω\n`;
                report += `–¢–µ–ª–µ—Ñ–æ–Ω –ø–µ—Ä–µ–¥ —Å–Ω–æ–º: ${record.phone === 'yes' ? '–î–∞' : '–ù–µ—Ç'}\n`;
                report += `–°–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ —É—Ç—Ä–æ–º: ${feelingText[record.feeling]}\n\n`;
            });
            
            // –°–∫–∞—á–∞—Ç—å
            const blob = new Blob([report], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sleep-report-toshka-${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
